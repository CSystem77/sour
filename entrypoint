#!/usr/bin/env bash

set -e

CONFIG_DIR=${CONFIG_DIR:-/sour/config}

mkdir -p "$CONFIG_DIR"

# Validate the user's configuration and export the combined config
export SOUR_CONFIG=$(cue export /sour/schema.cue /sour/default-config.yaml $(find $CONFIG_DIR -name '*.json' -or -name '*.yaml' or -name '*.cue'))

if [ -z "$SOUR_CONFIG" ]; then
  echo "A Sour config must be defined."
fi

# Update env vars in the source code
(cd /app/ && sed -i -e "s{__SOUR_CONFIG__{$SOUR_CONFIG{g" index.js)

wsproxy 28785 &
cluster &
nginx -g 'daemon off;' &

tail -F /bin/entrypoint
